#pragma once

#include "../includes.h"

namespace libredwg2 {

class Decoder;

class Parser
{
  ////////////////////////////////////////////////////////////////
  // Definitions
  ////////////////////////////////////////////////////////////////
  public:
    enum Release {
      R13,
      R14,
      R2000,
      R2004
    };

  ////////////////////////////////////////////////////////////////
  // Members
  ////////////////////////////////////////////////////////////////
  private:
    std::ifstream& fileBuffer_;

    int32_t previewOffset_;
    int16_t codepage_;
    int32_t securityFlags_;
    int32_t summaryOffset_;
    int32_t sectionMapOffset_;

  ////////////////////////////////////////////////////////////////
  // Constructors & Destructor
  ////////////////////////////////////////////////////////////////
  public:
    Parser(std::ifstream& fileBuffer);

    virtual ~Parser() {}

  ////////////////////////////////////////////////////////////////
  // Operators
  ////////////////////////////////////////////////////////////////
  private:

  ////////////////////////////////////////////////////////////////
  // Functions
  ////////////////////////////////////////////////////////////////
  public:
    virtual Release getVersionNumber() const = 0;

    core::ResultCode parse();

  private:
    virtual boost::shared_ptr<Decoder> getDecoder(int compressionMethod) = 0;

    virtual core::ResultCode parsePreview();

  private:
    core::ResultCode uncompress(core::MemBuffer& compressed, core::MemBuffer& clear, int type);

  public:
    static core::ResultCode create(std::ifstream& fileBuffer, boost::shared_ptr<Parser>& ptrLoader);
};

////////////////////////////////////////////////////////////////

}
